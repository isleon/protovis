<!DOCTYPE html>
<html>
  <head>
    <title>Sunburst</title>
    <meta charset="utf-8">
    <script type="text/javascript" src="keymap.js"></script>
    <style type="text/css">

#fig {
  width: 900px;
  margin-top: 5px;
  height: 900px;
  text-align: center;
}

text {
  font-size: 18px
}

    </style>
  </head>
  <body><div id="container"></div>
    <script>

var root = {
    title: '神算图',
    level: 0,
    nodes:[
      {
        value:1, color:'red', level:1,
        nodes:[
            {value:1, color:'red'}, 
            {value:2, color:'green'}, 
            {value:3, color:'blue'}
        ]
      }, 
      {
        value:2, color:'green', level:1,
        nodes:[
            {value:1, color:'red'}, 
            {value:2, color:'green'}, 
            {value:3, color:'blue'}
        ]
      }, 
      {
        value:3, color:'blue', level:1,
        nodes:[
            {value:1, color:'red'}, 
            {value:2, color:'green'}, 
            {value:3, color:'blue'}
        ]
      }, 
      {
        value:4, color:'orange', level:1,
        nodes:[
            {value:1, color:'red'}, 
            {value:2, color:'green'}, 
            {value:3, color:'blue'}
        ]
      }, 
    ]
};

var svgns = "http://www.w3.org/2000/svg";
var radiuses = [100, 200, 300]

var nodes = root.nodes
var totalAngle = Math.PI*2
var startAngle = 0

// 计算每个节点的角度和起始角度
var sum = nodes.reduce(function(s, d){ return s+d.value }, 0)
nodes.forEach(function(d, i) {d.angle = totalAngle * d.value/sum})
nodes.reduce(function(s, d){
    d.startAngle = s
    d.endAngle = d.startAngle + d.angle
    return d.endAngle
}, startAngle)

nodes.forEach(function(c, i){
    var nodes = c.nodes
    var totalAngle = c.angle
    var startAngle = c.startAngle
    // 计算每个节点的角度和起始角度
    var sum = nodes.reduce(function(s, d){ return s+d.value }, 0)
    nodes.forEach(function(d, i) {d.angle = totalAngle * d.value/sum})
    nodes.reduce(function(s, d){
        d.startAngle = s
        d.endAngle = d.startAngle + d.angle
        return d.endAngle
    }, startAngle)
})

console.log(root);

var size = 200

function create (type) { 
  return document.createElementNS(svgns, type);
}

function drawPie(chart, d, radius) {
    // primary wedge
    var path = document.createElementNS(svgns, "path");
    var startAngle = d.startAngle;
    var endAngle = d.endAngle;
    var x1 = 0 + radius * Math.sin(startAngle);
    var y1 = 0 - radius * Math.cos(startAngle);
    var x2 = 0 + radius * Math.sin(endAngle);
    var y2 = 0 - radius * Math.cos(endAngle);
    var big = (endAngle - startAngle > Math.PI) ? 1 : 0;

    var dd = "M 0,0" +  // Start at circle center
        " L " + x1 + "," + y1 +     // Draw line to (x1,y1)
        " A " + radius + "," + radius +       // Draw an arc of radius r
        " 0 " + big + " 1 " +       // Arc details...
        x2 + "," + y2 +             // Arc goes to to (x2,y2)
        " Z";                       // Close path back to (cx,cy)
    path.setAttribute("d", dd); // Set this path 
    path.setAttribute("fill", d.color);
    path.setAttribute("stroke", "rgb(255,255,255)")
    path.setAttribute("stroke-width", 1)
    path.setAttribute("transform", "translate(100,100)")
    chart.appendChild(path); // Add wedge to chart
}

function pieChart() {
    var chart = document.createElementNS(svgns, "svg");
    chart.setAttribute("width", size);
    chart.setAttribute("height", size);
    // chart.setAttribute("viewBox", "0 0 " + size + " " + size);

    // Background circle
    var back = document.createElementNS(svgns, "circle");
    back.setAttribute("cx", size / 2);
    back.setAttribute("cy", size / 2);
    back.setAttribute("r",  size / 2);

    var color = "#d0d0d0";
    back.setAttribute("fill", color);
    chart.appendChild(back);

    for (var i=0; i<nodes.length; i++) {

        for (var j=0; j<nodes[i].nodes.length; j++) {
            drawPie(chart, nodes[i].nodes[j], size/2)
        }
        drawPie(chart, nodes[i], size / 4)
    };

    // foreground circle
    var front = document.createElementNS(svgns, "circle");
    front.setAttribute("cx", (size / 2));
    front.setAttribute("cy", (size / 2));
    front.setAttribute("r",  (size * 0.17 /2)); //about 34% as big as back circle 
    front.setAttribute("fill", "#fff");
    chart.appendChild(front);
    return chart;
}

var c = document.getElementById('container');
c.appendChild( pieChart() );

    </script></body>
</html>
